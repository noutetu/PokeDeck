# Search関連クラスの仕組みと使い方

## クラス構成と役割

Search関連クラスは、MVPパターン（Model-View-Presenter）に基づいて設計されています。MonoBehaviour依存を最小限に抑え、テスト可能で保守性の高い構造になっています。

### 1. SearchModel
純粋なC#クラスで、検索ロジックとデータ管理を担当します。

```
- カードデータの保持と管理
- 検索条件（フィルター）の保持
- フィルタリングロジックの実装
```

### 2. SearchView (MonoBehaviour)
UIコンポーネントを扱うためMonoBehaviourを継承し、検索パネル内のユーザーインターフェースを管理します。

```
- 検索フォームの表示
- ユーザー入力の処理
- 検索結果のプレビュー表示
- MVPパターンのエントリーポイント
```

### 3. AllCardView (MonoBehaviour)
メインのカードリスト表示を担当するコンポーネントです。（以前はCardListViewという名前）

```
- カードリストの表示
- 検索ボタンによる検索パネル表示の制御
- 検索結果の反映
```

### 4. SearchPresenter
ViewとModelの橋渡しをする純粋なC#クラスです。

```
- Viewからの操作をModelに伝達
- Modelの処理結果をViewに反映
- ビジネスロジックの制御
```

### 5. SearchRouter (MonoBehaviour)
UIパネルの表示/非表示を管理するシングルトンクラスです。

```
- パネル間のナビゲーション
- 検索パネルの表示制御
- 検索結果のカードリストへの伝達
- イベント通知
```

### 6. SetCardTypeArea (MonoBehaviour)
カードタイプのフィルタリングを担当するコンポーネントです。

```
- カードタイプのトグルUI管理
- 「非EX」「EX」「サポート」「グッズ」「化石」「ポケモンの道具」のトグル状態管理
- 選択されたカードタイプのフィルター情報をPresenterに通知
```

## 実際の画面構成

### 1. カードリスト画面
```
+-----------------------------------------+
|                PokeDeck                 |
+-----------------------------------------+
| [検索入力フィールド]          [設定]    |
+-----------------------------------------+
|                                         |
|  +-------------+   +-------------+      |
|  | カード1     |   | カード2     |      |
|  |             |   |             |      |
|  |             |   |             |      |
|  |             |   |             |      |
|  +-------------+   +-------------+      |
|                                         |
|  +-------------+   +-------------+      |
|  | カード3     |   | カード4     |      |
|  |             |   |             |      |
|  |             |   |             |      |
|  |             |   |             |      |
|  +-------------+   +-------------+      |
|                                         |
+-----------------------------------------+
```

カードリスト画面では、フィルタリングされたカードが表示されます。画面上部の検索入力フィールドを使って、テキストによる検索が可能です。また、設定アイコンをタップして詳細なフィルター設定画面を開くこともできます。

### 2. カードタイプフィルター画面
```
+-----------------------------------------+
|           カードタイプフィルター        |
+-----------------------------------------+
|                                         |
|  +--------+  +--------+  +--------+     |
|  | 非EX   |  |   EX   |  |サポート|     |
|  +--------+  +--------+  +--------+     |
|                                         |
|  +--------+  +--------+  +--------+     |
|  | グッズ  |  | 化石   |  |ポケモン|     |
|  |        |  |        |  |の道具  |     |
|  +--------+  +--------+  +--------+     |
|                                         |
|                                         |
+-----------------------------------------+
|  [クリア]                      [OK]     |
+-----------------------------------------+
```

カードタイプフィルター画面では、以下のトグルボタンで簡単にカードをフィルタリングできます：

- 非EX
- EX
- サポート（緑色で選択されている状態）
- グッズ
- 化石
- ポケモンの道具

各トグルボタンは選択すると緑色に、非選択時は灰色で表示されます。画面下部のクリアボタンで選択をリセットでき、OKボタンで選択を確定します。

## 今後の画面構成案

### 3. 進化段階フィルター画面
```
+-----------------------------------------+
|            進化段階フィルター           |
+-----------------------------------------+
|                                         |
|  +-------------+  +-------------+       |
|  | たねポケモン |  |    進化1    |       |
|  +-------------+  +-------------+       |
|                                         |
|  +-------------+                        |
|  |    進化2    |                        |
|  +-------------+                        |
|                                         |
+-----------------------------------------+
|  [クリア]                      [OK]     |
+-----------------------------------------+
```

進化段階フィルター画面では、ポケモンの進化段階によるフィルタリングが可能です：

- たねポケモン
- 進化1
- 進化2

各ボタンは選択状態で緑色に、非選択状態では灰色で表示され、複数選択が可能です。

### 4. ポケモンタイプフィルター画面
```
+-----------------------------------------+
|          ポケモンタイプフィルター       |
+-----------------------------------------+
|                                         |
|  +------+  +------+  +------+  +------+ |
|  |  草  |  |  炎  |  |  水  |  |  雷  | |
|  +------+  +------+  +------+  +------+ |
|                                         |
|  +------+  +------+  +------+  +------+ |
|  |  闘  |  |  超  |  |  悪  |  |  鋼  | |
|  +------+  +------+  +------+  +------+ |
|                                         |
|  +--------+  +--------+                 |
|  |ドラゴン|  | 無色  |                  |
|  +--------+  +--------+                 |
|                                         |
+-----------------------------------------+
|  [クリア]                      [OK]     |
+-----------------------------------------+
```

ポケモンタイプフィルター画面では、ポケモンの属性タイプによるフィルタリングが可能です。各タイプのボタンはそれぞれのタイプカラーで表示され、選択状態では明るく、非選択状態では暗い色調で表示されます。

### 5. カードパックフィルター画面
```
+-----------------------------------------+
|          カードパックフィルター         |
+-----------------------------------------+
|                                         |
|  +----------------+  +----------------+ |
|  |  最強の遺伝子   |  |   幻のいる島   | |
|  +----------------+  +----------------+ |
|                                         |
|  +----------------+  +----------------+ |
|  |  時空の激闘    |  |   超克の光     | |
|  +----------------+  +----------------+ |
|                                         |
|  +----------------+  +----------------+ |
|  | シャイニングハイ |  | 双天の守護者  | |
|  +----------------+  +----------------+ |
|                                         |
|  +----------------+                     |
|  |     PROMO      |                     |
|  +----------------+                     |
|                                         |
+-----------------------------------------+
|  [クリア]                      [OK]     |
+-----------------------------------------+
```

カードパックフィルター画面では、カードの収録パックごとにフィルタリングができます。各パックは発売順に配置され、ユーザーが特定のパックのカードだけを表示したい場合に便利です。

### 6. 複合検索画面（提案）
```
+-----------------------------------------+
|               詳細検索                  |
+-----------------------------------------+
| [検索ワード入力]                        |
+-----------------------------------------+
| ◎ カードタイプ                         |
|  [非EX] [EX] [サポート] [グッズ] [...]  |
+-----------------------------------------+
| ◎ 進化段階                             |
|  [たね] [進化1] [進化2]                 |
+-----------------------------------------+
| ◎ ポケモンタイプ                       |
|  [草] [炎] [水] [雷] [...]              |
+-----------------------------------------+
| ◎ カードパック                         |
|  [最強の遺伝子] [幻のいる島] [...]      |
+-----------------------------------------+
| ◎ カードタグ                           |
|  □ エネルギー関連                      |
|    [エネルギー加速] [付け替え] [...]    |
|  □ ダメージ関連                        |
|    [ダメージアップ] [回復] [...]        |
|  □ 手札/山札関連                       |
|    [ドロー] [サーチ] [...]              |
+-----------------------------------------+
|  [リセット]                    [検索]   |
+-----------------------------------------+
```

複合検索画面では、すべてのフィルター条件を一画面で設定できます。カードタグは機能別にグループ化され、階層的に表示されます。この画面により、より精密な条件でのカード検索が可能になります。

## 処理の流れ

1. **初期表示**:
   - アプリケーション起動時、`AllCardView`が初期カードリストを表示
   - 検索パネルは非表示状態

2. **検索パネル表示**:
   - ユーザーが設定アイコンまたは検索ボタンをクリック
   - `SearchRouter.ShowSearchPanel()`が呼び出され、検索パネルが表示される

3. **カードタイプフィルター設定**:
   - ユーザーがカードタイプのトグルボタンを選択
   - `SetCardTypeArea`が選択状態を管理し、変更を`SearchPresenter`に通知
   - `SearchPresenter`が`SearchModel`にフィルター条件を設定

4. **検索条件設定と実行**:
   - フィルターが変更されるとリアルタイムで検索が実行される
   - 結果はパネル内でプレビュー表示される

5. **検索結果の適用**:
   - OKボタンをクリックすると、`SearchView`が`SearchRouter.ApplySearchResults()`を呼び出す
   - `SearchRouter`が検索結果を`OnSearchResult`イベントで`AllCardView`に伝達
   - `AllCardView`がカードリストを更新して検索結果を反映
   - 検索パネルが閉じる

6. **キャンセル**:
   - キャンセルボタン（×）をクリックすると、検索パネルが閉じ、カードリストは更新されない

7. **フィルタークリア**:
   - クリアボタンをクリックすると、すべてのフィルター設定がリセットされる
   - トグルボタンの状態も視覚的にリセットされる（非選択状態の灰色に戻る）

## コンポーネント間の連携

### SetCardTypeArea と SearchPresenter の連携

```csharp
// SetCardTypeArea.cs
private void SetupToggleListener(Toggle toggle, CardType cardType)
{
    if (toggle == null) return;
    
    toggle.onValueChanged.AddListener((isOn) => {
        if (isOn)
        {
            selectedCardTypes.Add(cardType);
        }
        else
        {
            selectedCardTypes.Remove(cardType);
        }
        
        // フィルター変更を通知
        OnFilterChanged?.Invoke();
    });
}
```

```csharp
// SearchPresenter.cs
public void RegisterCardTypeArea(SetCardTypeArea area)
{
    this.cardTypeArea = area;
    
    // カードタイプフィルターのイベントを登録
    if (cardTypeArea != null)
    {
        cardTypeArea.OnFilterChanged += () => {
            model.SetCardTypeFilter(cardTypeArea.GetSelectedCardTypes());
            UpdateView();
        };
    }
}
```

### SearchModel のフィルタリング処理

```csharp
// SearchModel.cs
public void SetCardTypeFilter(HashSet<CardType> cardTypes)
{
    selectedCardTypes = new HashSet<CardType>(cardTypes);
    ApplyFilters();
}

private void ApplyCardTypeFilter()
{
    // カードタイプフィルターが設定されていない場合はスキップ
    if (selectedCardTypes.Count == 0) return;
    
    // カードタイプによるフィルタリング
    filteredCards = filteredCards.Where(card => 
        selectedCardTypes.Contains(card.cardTypeEnum)
    ).ToList();
}
```

## 重要なポイント

1. **トグルの色の管理**
   - トグルボタンの状態は`SimpleToggleColor`コンポーネントで視覚的に表現
   - トグル選択時は緑色、非選択時は灰色に変更される
   - フィルターリセット時は`UpdateColorState`メソッドで色も適切にリセット

2. **カードタイプの変換処理**
   - JSONから読み込まれる文字列データは`EnumConverter.ToCardType`で列挙型に変換
   - 変換結果はログに出力され、デバッグに役立つ

3. **フィルタリング結果の分析**
   - フィルタリング前後のカードタイプ分布をログに出力
   - これにより、フィルタリングが正しく機能しているか検証可能

4. **SearchRouterの役割**
   - パネル表示/非表示を一元管理
   - 検索結果をメインカードリスト画面に伝達

## カスタマイズ方法

### 新しいカードタイプの追加

新しいカードタイプを追加する場合は、以下の手順で実装します：

1. **Enums.csにカードタイプを追加**

```csharp
// Enums.cs
public enum CardType
{
    非EX,
    EX,
    サポート,
    グッズ,
    ポケモンの道具,
    化石,
    // 新しいカードタイプを追加
    エネルギー,
}
```

2. **EnumConverter.csに変換ロジックを追加**

```csharp
// EnumConverter.cs
public static CardType ToCardType(string typeString)
{
    switch (typeString)
    {
        case "非EX": return CardType.非EX;
        case "EX": return CardType.EX;
        case "サポート": return CardType.サポート;
        case "グッズ": return CardType.グッズ;
        case "ポケモンの道具": return CardType.ポケモンの道具;
        case "グッズ(化石)": return CardType.化石;
        // 新しいカードタイプの変換を追加
        case "エネルギー": return CardType.エネルギー;
        default:
            Debug.LogError($"❌ 未知のカードタイプ: {typeString}");
            return default;
    }
}
```

3. **SetCardTypeArea.csにトグルを追加**

```csharp
// SetCardTypeArea.cs
[Header("カードタイプトグル")]
[SerializeField] private Toggle nonEXToggle;
[SerializeField] private Toggle exToggle;
[SerializeField] private Toggle supportToggle;
[SerializeField] private Toggle itemToggle;
[SerializeField] private Toggle fossilToggle;
[SerializeField] private Toggle pokemonToolToggle;
// 新しいカードタイプのトグルを追加
[SerializeField] private Toggle energyToggle;

private void InitializeToggles()
{
    // トグルとカードタイプのマッピング設定
    SetupToggleListener(nonEXToggle, CardType.非EX);
    SetupToggleListener(exToggle, CardType.EX);
    SetupToggleListener(supportToggle, CardType.サポート);
    SetupToggleListener(itemToggle, CardType.グッズ);
    SetupToggleListener(fossilToggle, CardType.化石);
    SetupToggleListener(pokemonToolToggle, CardType.ポケモンの道具);
    // 新しいカードタイプのトグルを設定
    SetupToggleListener(energyToggle, CardType.エネルギー);
}
```

### 他のフィルター（ポケモンタイプ、進化段階など）の追加

ポケモンタイプや進化段階などの追加フィルターを実装する場合は、カードタイプと同様のパターンで実装できます：

1. フィルター用のUIコンポーネントを作成（SetPokemonTypeAreaなど）
2. SearchPresenterでコンポーネントを登録
3. フィルター条件をSearchModelに追加

## トラブルシューティング

1. **トグルの見た目が更新されない場合**
   - `SimpleToggleColor`コンポーネントの`UpdateColorState`メソッドが呼ばれているか確認
   - `SetIsOnWithoutNotify`使用後は明示的に色を更新する必要がある

2. **フィルタリングが正しく機能しない場合**
   - ログ出力を確認し、カードタイプの変換が正しく行われているか検証
   - フィルタリング前後のカード分布を確認

3. **検索パネルが表示されない場合**
   - `SearchRouter`が正しく初期化されているか確認
   - `SetPanels`メソッドが正しく呼び出されているか確認

## まとめ

カードタイプフィルタリング機能は、MVPパターンに基づいて実装されており、保守性と拡張性の高い設計になっています。トグルボタンでの簡単な操作で、ユーザーは素早くカードを絞り込むことができます。今後、ポケモンタイプや進化段階などの追加フィルターも同様のパターンで簡単に実装できます。